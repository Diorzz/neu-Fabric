[TOC]

# Fabric特性及其基本概念

Fabric 是一个开源的、面向企业的区块链解决平台，俗称“联盟链”。在这一章首先介绍 Fabric 的特点以及 Fabrci 的一些基本概念，章节内容主要参考以下资料：

> - [Hyperledger Fabric: A Distributed Operating System for Permissioned Blockchains](https://arxiv.org/pdf/1801.10228.pdf)
> - [Fabric文档](https://hyperledger-fabric.readthedocs.io/zh_CN/latest/blockchain.html)

## 与传统公链的区别

这里我画了一张表来清晰地显示出了 Fabric 与 Ethereum/Bitcoin 的区别：

项目\名称 | Ethereum/Bitcoin | Fabric
---|---|---
参与方式 | 任何节点都可以参与 | 只有被许可的节点才能参与
权限 | 所有节点对等，同权（PoW机制下） | 不同的节点有不同的角色，不同角色做不同的工作 
智能合约 | <ul><li>使用特定的语言</li><li>被所有节点执行</li><li>用Gas费防止崩溃</li></ul> | <ul><li>使用主流编程语言</li><li>部分节点执行</li><li>无特殊限制</li></ul>
共识 | 固定的共识算法；共识参与账本验证 | 模块化共识；共识不参与账本验证
扩展性 | 无扩展 | 可动态添加或删除多个联盟
一致性 | 存在分叉 | 不会分叉，每一个区块都是确定的
安全性（隐私） | 公开透明，没有隐私 | 可以配置数据的可见范围
性能 | 效率低下，不足以支撑大型应用 | 性能表现良好，可支持复杂应用

可以看出，Fabric 有很多的改进和优点，这也是其能作为联盟链得到广泛应用的原因。

## Fabric账本更新流程

在 [Hyperledger Fabric: A Distributed Operating System for Permissioned Blockchains](https://arxiv.org/pdf/1801.10228.pdf) 论文中，前半部分主要阐述了其交易的执行流程和传统公链的差别，以此来突出 Fabric 的特点：

![image](https://note.youdao.com/yws/public/resource/0bd8b91ffd577bb5a3b274dbb1c695ee/xmlnote/WEBRESOURCE4cfcfe56853905c4db88ee637534343c/12699)

上图展示了在 Fabric 中账本的更新过程：
1. 在部分节点执行交易，生成读写集并收集背书
2. 将上步的执行结果进行排序（共识）并生成区块
3. 节点验证区块中的交易
4. 将正确的交易更新到账本中

与传统公链系统不同的是，交易首先被部分节点执行，相比于所有节点运行交易，避免了可能的性能瓶颈；其次，共识仅仅是对交易进行排序，并不参与账本的验证，这加快了共识的效率；最后，只将共识后的结果更到账本即可。具体的执行细节将在后面的章节描述。

## Fabric组件

Fabric 主要包含以下组件（功能模块）他们相互协调工作：
- Membership Service Provider（MSP）：提供成员管理服务，主要为节点生成证书，为其关联到相关组织，验证成员身份等
- Ordering Service（OS）：排序服务，主要做交易的共识和区块的生成
- Ledger：系统数据账本，主要包含存储历史交易的区块链账本和交易执行改变的世界状态
- Chain Code：链码，可以理解为智能合约，用于生成交易。
- Gossip：用于节点互联及消息的传递

## 成员管理及策略

作为许可链，节点需要得到特定的授权才能加入到网络中。MSP负责成员身份的管理，同时系统还需要结合一些策略（配置）来固定哪些节点具有哪些权限或者交易需要哪些节点背书等等。

## 节点

Fabric 中大体分为两类节点：
- Peer：用于执行交易，验证交易等
- Order Peer：排序节点，用于参与交易的排序

其中 Peer 节点既可以存储链码又可以不存储，存储链码可以作为背书节点为交易背书，不存储链码的节点仅仅负责保存账本

## Channel

Channel 是 Fabric 中一个特别的概念，用于联盟的划分、之间成员的相互通信等。下面借用官方的一个图片来讲述下 Channel ：

![image](https://hyperledger-fabric.readthedocs.io/zh_CN/latest/_images/network.diagram.1.png)

上图中 R1,R2..R4 表示4个不同的组织，P1,P2,P3 分别为这三个组织运行的三个节点，可以看到 P1,P2 连接到了同一个 C1 上，P2,O4 连接到了 C2 上，C 表示一个 Channel，这就说明，P1,P2 可以通过 Channel1 进行通信和数据共享，P2 和 O4 又可以通过 Channle2 进行通信。

## 排序

在 Fabric 中共识仅仅是将交易排序并达成一致结果（生成确定的区块）这种方式提高了共识的速度。另外，确定性的结果也提高了系统的性能。

可以用不同的算法来执行排序工作，例如：`Raft`,`kafka`等

## 链码

链码可以理解为智能合约，链码的部署及执行步骤：

- 客户端将链码发送到节点
- 节点将链码注册到 channel 中
- 背书节点复制链码副本到本地
- 客户端发送 proposal 触发链码执行
    - 如果是查询，节点执行合约后立即返回
    - 如果涉及到账本更新，节点执行合约（不更新账本）后返回读写集
- 客户端收集读写集及背书节点的背书（不同节点对相同读写集的签名）
- 客户端将交易发送到 channel 中
- 排序节点收集交易执行排序并生成区块
- 区块被发送到各个 Peer，Peer 验证区块中的交易后更新账本

链码可以用常用的变成语言如 Go、Js编写

## 账本

账本即是系统中保存的数据，其中主要包含两方面：

- 存储交易历史的区块链
- 存储所有业务对象的世界状态

### 区块链
系统将所有的历史交易打包到区块中并使区块相互连接成一条链，因此区块链中记录的事不可更改的、确定的、历史的交易的集合。

### 世界状态

我们可以看下面一组数据：
```json
{
    "name": "zz","age": "27",
}
```
上面的数据定义了一个人的基本信息，在某段时间这组数据及其值构成了一个状态 **S**，如果下一个时间程序修改了数据：
```json
{
    "name": "zz","age": "28",
}
```
那么新的数据和值就构成了另一个状态 **S'**。在区块链中所有的数据构成了世界状态，智能合约的执行结果本质上就是对数据的修改使其进入下一个世界状态。


